{"version":3,"file":"index.js","sources":["../src/server.js","../src/client.js","../src/provider.js","../src/plugin.js","../src/hoc.js","../src/index.js"],"sourcesContent":["/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env node */\nimport * as React from 'react';\nimport {renderToString} from 'react-dom/server';\n\nexport default (el: React.Element<*>) =>\n  `<div id='root'>${renderToString(el)}</div>`;\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport * as React from 'react';\nimport ReactDOM from 'react-dom';\n\nexport default (el: React.Element<*>) => {\n  const domElement = document.getElementById('root');\n\n  if (!domElement) {\n    throw new Error(\"Could not find 'root' element\");\n  }\n\n  return ReactDOM.hydrate\n    ? ReactDOM.hydrate(el, domElement)\n    : ReactDOM.render(el, domElement);\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\nimport PropTypes from 'prop-types';\n\nexport default {\n  create: (name: string) => {\n    class Provider extends React.Component<*> {\n      getChildContext() {\n        return {[name]: this.props.provides};\n      }\n      render() {\n        return React.Children.only(this.props.children);\n      }\n    }\n    Provider.childContextTypes = {\n      ...(Provider.childContextTypes || {}),\n      [name]: PropTypes.any.isRequired,\n    };\n    Provider.displayName =\n      name.replace(/^./, c => c.toUpperCase()) + 'Provider';\n\n    return Provider;\n  },\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\n\nimport {createPlugin} from 'fusion-core';\nimport type {FusionPlugin, Middleware} from 'fusion-core';\n\nimport Provider from './provider';\n\n// eslint-disable-next-line\ntype FusionPluginNoHidden<TDeps, TService> = $Diff<\n  FusionPlugin<TDeps, TService>,\n  {__plugin__: boolean}\n>;\n\nexport default {\n  create: <TDeps: *, TService: *>(\n    name: string,\n    // eslint-disable-next-line\n    plugin: FusionPluginNoHidden<TDeps, TService> | FusionPlugin<TDeps, TService>,\n    provider?: React.ComponentType<*>\n  ): FusionPlugin<TDeps, TService> => {\n    if (plugin.__plugin__ === undefined) {\n      plugin = createPlugin(plugin);\n    }\n    if (!plugin.__plugin__) {\n      throw new Error(\n        'Provided plugin does not match FusionPlugin<TDeps, TService>'\n      );\n    }\n\n    let originalMiddleware = plugin.middleware;\n    const ProviderComponent = provider || Provider.create(name);\n    plugin.middleware = (deps: *, provides: *) => {\n      let nextMiddleware =\n        originalMiddleware && originalMiddleware(deps, provides);\n      const mw: Middleware = function(ctx, next) {\n        if (ctx.element) {\n          ctx.element = React.createElement(\n            ProviderComponent,\n            {provides, ctx},\n            ctx.element\n          );\n        }\n        if (nextMiddleware) {\n          return nextMiddleware(ctx, next);\n        }\n        return next();\n      };\n      return mw;\n    };\n    return plugin;\n  },\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\n\nimport PropTypes from 'prop-types';\n\ntype ReactHOC = (React.ComponentType<*>) => React.ComponentType<*>;\nexport default {\n  create: (name: string, mapProvidesToProps?: Object => Object): ReactHOC => {\n    const mapProvides = mapProvidesToProps\n      ? mapProvidesToProps\n      : provides => ({[name]: provides});\n    return (Component: React.ComponentType<*>) => {\n      class HOC extends React.Component<*> {\n        provides: any;\n\n        constructor(props: *, ctx: *) {\n          super(props, ctx);\n          this.provides = ctx[name];\n        }\n        render() {\n          const props = {...this.props, ...mapProvides(this.provides)};\n          return React.createElement(Component, props);\n        }\n      }\n      const displayName = Component.displayName || Component.name;\n      HOC.displayName =\n        'With' +\n        name.replace(/^./, c => c.toUpperCase()) +\n        '(' +\n        displayName +\n        ')';\n      HOC.contextTypes = {\n        [name]: PropTypes.any.isRequired,\n      };\n      return HOC;\n    };\n  },\n};\n","/** Copyright (c) 2018 Uber Technologies, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\n/* eslint-env browser */\nimport * as React from 'react';\n\nimport FusionApp, {createPlugin} from 'fusion-core';\nimport {prepare, middleware} from 'fusion-react-async';\n\nimport serverRender from './server';\nimport clientRender from './client';\n\nimport ProviderPlugin from './plugin';\nimport ProvidedHOC from './hoc';\nimport Provider from './provider';\n\ndeclare var __NODE__: Boolean;\n\nexport default class App extends FusionApp {\n  constructor(root: React.Element<*>, render: ?(React.Element<*>) => any) {\n    const renderer = createPlugin({\n      provides() {\n        return (el: React.Element<*>) => {\n          return prepare(el).then(() => {\n            if (render) {\n              return render(el);\n            }\n            return __NODE__ ? serverRender(el) : clientRender(el);\n          });\n        };\n      },\n      middleware() {\n        return middleware;\n      },\n    });\n    super(root, renderer);\n  }\n}\n\nexport {ProviderPlugin, ProvidedHOC, Provider};\n"],"names":["el","renderToString","name","Provider","React","props","provides","only","children","childContextTypes","PropTypes","any","isRequired","displayName","replace","c","toUpperCase","plugin","provider","__plugin__","undefined","createPlugin","Error","originalMiddleware","middleware","ProviderComponent","create","deps","nextMiddleware","mw","ctx","next","element","mapProvidesToProps","mapProvides","Component","HOC","contextTypes","App","FusionApp","root","render","renderer","prepare","then","serverRender"],"mappings":";;;;;;;;;;;;;AAAA;;;;;;;;;AASA,AAGA,oBAAgBA,EAAD,IACZ,kBAAiBC,sBAAeD,EAAf,CAAmB,QADvC;;ACZA;;;;;;;;;;;;;;;;;;;;;ACQA,AAGA,eAAe;UACJE,IAAD,IAAkB;UAClBC,QAAN,SAAuBC,eAAvB,CAA0C;wBACtB;eACT;WAAEF,IAAD,GAAQ,KAAKG,KAAL,CAAWC;SAA3B;;;eAEO;eACAF,cAAA,CAAeG,IAAf,CAAoB,KAAKF,KAAL,CAAWG,QAA/B,CAAP;;;;;aAGKC,iBAAT,qBACMN,SAASM,iBAAT,IAA8B,EADpC;OAEGP,IAAD,GAAQQ,UAAUC,GAAV,CAAcC;;aAEfC,WAAT,GACEX,KAAKY,OAAL,CAAa,IAAb,EAAmBC,KAAKA,EAAEC,WAAF,EAAxB,IAA2C,UAD7C;WAGOb,QAAP;;CAjBJ;;ACXA;;;;;;;AAQA,AAaA,aAAe;UACL,CACND,IADM,EAGNe,MAHM,EAINC,QAJM,KAK4B;QAC9BD,OAAOE,UAAP,KAAsBC,SAA1B,EAAqC;eAC1BC,uBAAaJ,MAAb,CAAT;;;QAEE,CAACA,OAAOE,UAAZ,EAAwB;YAChB,IAAIG,KAAJ,CACJ,8DADI,CAAN;;;QAKEC,qBAAqBN,OAAOO,UAAhC;UACMC,oBAAoBP,YAAYf,SAASuB,MAAT,CAAgBxB,IAAhB,CAAtC;;WACOsB,UAAP,GAAoB,CAACG,IAAD,EAAUrB,QAAV,KAA0B;UACxCsB,iBACFL,sBAAsBA,mBAAmBI,IAAnB,EAAyBrB,QAAzB,CADxB;;YAEMuB,KAAiB,UAASC,GAAT,EAAcC,IAAd,EAAoB;YACrCD,IAAIE,OAAR,EAAiB;cACXA,OAAJ,GAAc5B,mBAAA,CACZqB,iBADY,EAEZ;oBAAA;;WAFY,EAGZK,IAAIE,OAHQ,CAAd;;;YAMEJ,cAAJ,EAAoB;iBACXA,eAAeE,GAAf,EAAoBC,IAApB,CAAP;;;eAEKA,MAAP;OAXF;;aAaOF,EAAP;KAhBF;;WAkBOZ,MAAP;;CApCJ;;;;;;;;;;;;;ACbA,AAKA,UAAe;UACL,CAACf,IAAD,EAAe+B,kBAAf,KAAmE;UACnEC,cAAcD,qBAChBA,kBADgB,GAEhB3B,aAAa;OAAEJ,IAAD,GAAQI;KAAtB,CAFJ;WAGQ6B,SAAD,IAAuC;YACtCC,GAAN,SAAkBhC,eAAlB,CAAqC;oBAGvBC,KAAZ,EAAsByB,GAAtB,EAA8B;gBACtBzB,KAAN,EAAayB,GAAb;eACKxB,QAAL,GAAgBwB,IAAI5B,IAAJ,CAAhB;;;iBAEO;gBACDG,4BAAY,KAAKA,KAAjB,EAA2B6B,YAAY,KAAK5B,QAAjB,CAA3B,CAAN;;iBACOF,mBAAA,CAAoB+B,SAApB,EAA+B9B,KAA/B,CAAP;;;;;YAGEQ,cAAcsB,UAAUtB,WAAV,IAAyBsB,UAAUjC,IAAvD;UACIW,WAAJ,GACE,SACAX,KAAKY,OAAL,CAAa,IAAb,EAAmBC,KAAKA,EAAEC,WAAF,EAAxB,CADA,GAEA,GAFA,GAGAH,WAHA,GAIA,GALF;UAMIwB,YAAJ,GAAmB;SAChBnC,IAAD,GAAQQ,UAAUC,GAAV,CAAcC;OADxB;aAGOwB,GAAP;KAvBF;;CALJ;;ACbA;;;;;;;;;AASA,AAce,MAAME,GAAN,SAAkBC,kBAAlB,CAA4B;cAC7BC,IAAZ,EAAoCC,MAApC,EAAwE;UAChEC,WAAWrB,uBAAa;iBACjB;eACDrB,EAAD,IAA0B;iBACxB2C,yBAAQ3C,EAAR,EAAY4C,IAAZ,CAAiB,MAAM;gBACxBH,MAAJ,EAAY;qBACHA,OAAOzC,EAAP,CAAP;;;mBAEK,AAAW6C,aAAa7C,EAAb,CAAX,AAAP;WAJK,CAAP;SADF;OAF0B;;mBAWf;eACJwB,2BAAP;;;KAZa,CAAjB;UAeMgB,IAAN,EAAYE,QAAZ;;;;;;;;;;"}